<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Мои анализы</title>
    <link rel="stylesheet" href="/style/profile-menu.css">
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-4">
        <div class="row">
            <!-- Меню профиля -->
            <div class="col-lg-3 mb-4">
                <div th:replace="~{fragments/profile-menu::profile-menu}"></div>
            </div>

            <!-- Контент страницы -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-moisture me-2"></i>Мои анализы почвы
                            <span class="badge bg-primary" th:text="${analyses.size()}">3</span>
                        </h4>
                        <a th:href="@{/soil-analysis}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Новый анализ
                        </a>
                    </div>
                    <div class="card-body">
                        <div th:if="${not #lists.isEmpty(analyses)}">
                            <div th:each="analysis : ${analyses}" class="card mb-4">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="bi bi-flower1 me-2"></i>Анализ почвы <span class="analysis-status"
                                                                                                 th:class="${analysis.createdAt != null} ? 'bg-success text-white' : 'bg-warning text-dark'"
                                                                                                 th:text="${analysis.createdAt != null} ?
                                                     'от ' + ${#temporals.format(analysis.createdAt, 'dd.MM.yyyy')} :
                                                     'Дата не указана'">
                                            от 01.01.2024
                                        </span>
                                        </h5>

                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Показатели анализа -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>Основные показатели:</h6>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <small class="text-muted">pH уровень:</small>
                                                    <div th:if="${analysis.ph != null}">
                                                        <span th:class="${analysis.ph < 6.0} ? 'nutrient-level level-low' :
                                                                      (${analysis.ph > 7.5} ? 'nutrient-level level-high' : 'nutrient-level level-medium')"
                                                              th:text="${analysis.ph}">6.5</span>
                                                    </div>
                                                    <div th:if="${analysis.ph == null}">
                                                        <span class="text-muted">—</span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Органика:</small>
                                                    <div th:if="${analysis.organicMatter != null}">
                                                        <span th:class="${analysis.organicMatter < 2.0} ? 'nutrient-level level-low' :
                                                                      (${analysis.organicMatter > 4.0} ? 'nutrient-level level-high' : 'nutrient-level level-medium')"
                                                              th:text="${analysis.organicMatter} + '%'">3.2%</span>
                                                    </div>
                                                    <div th:if="${analysis.organicMatter == null}">
                                                        <span class="text-muted">—</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Макроэлементы (mg/kg):</h6>
                                            <div class="row g-2">
                                                <div class="col-4">
                                                    <small class="text-muted">N:</small>
                                                    <div th:if="${analysis.nitrogen != null}">
                                                        <span th:class="${analysis.nitrogen < 20} ? 'nutrient-level level-low' :
                                                                      (${analysis.nitrogen > 40} ? 'nutrient-level level-high' : 'nutrient-level level-medium')"
                                                              th:text="${analysis.nitrogen}">25</span>
                                                    </div>
                                                    <div th:if="${analysis.nitrogen == null}">
                                                        <span class="text-muted">—</span>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">P:</small>
                                                    <div th:if="${analysis.phosphorus != null}">
                                                        <span th:class="${analysis.phosphorus < 15} ? 'nutrient-level level-low' :
                                                                      (${analysis.phosphorus > 25} ? 'nutrient-level level-high' : 'nutrient-level level-medium')"
                                                              th:text="${analysis.phosphorus}">18</span>
                                                    </div>
                                                    <div th:if="${analysis.phosphorus == null}">
                                                        <span class="text-muted">—</span>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">K:</small>
                                                    <div th:if="${analysis.potassium != null}">
                                                        <span th:class="${analysis.potassium < 100} ? 'nutrient-level level-low' :
                                                                      (${analysis.potassium > 200} ? 'nutrient-level level-high' : 'nutrient-level level-medium')"
                                                              th:text="${analysis.potassium}">150</span>
                                                    </div>
                                                    <div th:if="${analysis.potassium == null}">
                                                        <span class="text-muted">—</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Рекомендации -->
                                    <div th:if="${not #lists.isEmpty(analysis.recommendations)}" class="mb-3">
                                        <h6 class="text-success">
                                            <i class="bi bi-lightbulb me-1"></i>Рекомендации:
                                            <span class="badge bg-success" th:text="${analysis.recommendations.size()}">2</span>
                                        </h6>
                                        <div class="ps-3">
                                            <div th:each="rec : ${analysis.recommendations}" class="small mb-1">
                                                <i class="bi bi-arrow-right-short text-success"></i>
                                                <span th:text="${rec.elementName}">Азот</span> -
                                                <span th:text="${rec.reason}">низкое содержание</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${#lists.isEmpty(analysis.recommendations)}" class="mb-3">
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-info-circle me-1"></i>Рекомендации не сгенерированы
                                        </p>
                                    </div>

                                    <!-- Кнопки действий -->
                                    <div class="d-flex justify-content-between align-items-center border-top pt-3">
                                        <div>
                                            <a th:href="@{/soilAnalysis/{id}(id=${analysis.id})}"
                                               class="btn btn-outline-primary btn-sm me-2">
                                                <i class="bi bi-eye me-1"></i>Подробнее
                                            </a>
                                            <a th:href="@{/soilAnalysis/recommendations/{id}(id=${analysis.id})}"
                                               class="btn btn-outline-success btn-sm me-2">
                                                <i class="bi bi-lightbulb me-1"></i>Рекомендации
                                            </a>
                                        </div>
                                        <div>
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>
                                                <span th:if="${analysis.createdAt != null}"
                                                      th:text="${#temporals.format(analysis.createdAt, 'dd.MM.yyyy HH:mm')}">
                                                    01.01.2024 14:30
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(analyses)}" class="text-center py-5">
                            <i class="bi bi-moisture display-4 text-muted"></i>
                            <h4 class="mt-3">У вас пока нет анализов почвы</h4>
                            <p class="text-muted">Создайте первый анализ для получения рекомендаций по улучшению почвы</p>
                            <a th:href="@{/soilAnalysis/new}" class="btn btn-primary mt-2">
                                <i class="bi bi-plus-circle me-2"></i>Создать первый анализ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>
</body>
</html>
